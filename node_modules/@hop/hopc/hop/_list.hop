;*=====================================================================*/
;*    serrano/prgm/project/hop/hop/node_modules/hopc/hop/_list.hop     */
;*    -------------------------------------------------------------    */
;*    Author      :  manuel serrano                                    */
;*    Creation    :  Mon Nov 27 08:15:18 2023                          */
;*    Last change :  Wed Jun 19 09:24:32 2024 (serrano)                */
;*    Copyright   :  2023-24 manuel serrano                            */
;*    -------------------------------------------------------------    */
;*    Wrapper for List for compatibility with the Nodejs port.         */
;*=====================================================================*/

;*---------------------------------------------------------------------*/
;*    The module                                                       */
;*---------------------------------------------------------------------*/
(module _list
   
   (library hopscript hop nodejs js2scheme)
   
   (export (hopscript ::JsGlobalObject ::JsObject ::JsObject ::JsObject)))
	   
;*---------------------------------------------------------------------*/
;*    hopscript ...                                                    */
;*---------------------------------------------------------------------*/
(define (hopscript %this this %scope %module)
   
   (js-export (list list2array array2list cons pairp car cdr setCar setCdr lastPair map forEach)
      
      (define exports (js-get %module (& "exports") %this))

      ;; pairp
      (define pairp
	 (js-make-function %this
	    (lambda (this obj)
	       (pair? obj))
	    (js-function-arity 1 0)
	    (js-function-info :name "pairp" :len 1)
	    :size 1))
	 
      (js-bind! %this exports (& "pairp")
	 :value pairp
	 :writable #f
	 :enumerable #t)
      
      ;; cons
      (define cons
	 (js-make-function %this
	    (lambda (this car cdr)
	       ((@ cons __r4_pairs_and_lists_6_3) car cdr))
	    (js-function-arity 2 0)
	    (js-function-info :name "cons" :len 2)
	    :size 2))
	 
      (js-bind! %this exports (& "cons")
	 :value cons
	 :writable #f
	 :enumerable #t)
      
      ;; list
      (define list
	 (js-make-function %this
	    (lambda (this . args)
	       args)
	    (js-function-arity -1 0)
	    (js-function-info :name "list" :len 1)
	    :size 1))
	 
      (js-bind! %this exports (& "list")
	 :value list
	 :writable #f
	 :enumerable #t)

      ;; list2array
      (define list2array
	 (js-make-function %this
	    (lambda (this lst)
	       (cond
		  ((pair? lst)
		   (js-vector->jsarray (apply vector lst) %this))
		  ((null? lst)
		   (js-empty-vector->jsarray %this))
		  ((js-array? lst)
		   lst)
		  (else
		   (js-raise-type-error %this
		      (format "list2array: not an array (~a) ~~a" (typeof lst))
		      lst))))
	    (js-function-arity 1 0)
	    (js-function-info :name "list2array" :len 1)
	    :size 1))
      
      (js-bind! %this exports (& "list2array")
	 :value list2array
	 :writable #f
	 :enumerable #t)

      ;; array2list
      (define array2list
	 (js-make-function %this
	    (lambda (this arr)
	       (jsarray->list arr %this))
	    (js-function-arity 1 0)
	    (js-function-info :name "array2list" :len 1)
	    :size 1))
      
      (js-bind! %this exports (& "array2list")
	 :value array2list
	 :writable #f
	 :enumerable #t)

      ;; car
      (define car
	 (js-make-function %this
	    (lambda (this obj)
	       ((@ car __r4_pairs_and_lists_6_3) obj))
	    (js-function-arity 1 0)
	    (js-function-info :name "car" :len 1)
	    :size 1))
	 
      (js-bind! %this exports (& "car")
	 :value car
	 :writable #f
	 :enumerable #t)

      ;; cdr
      (define cdr
	 (js-make-function %this
	    (lambda (this obj)
	       ((@ cdr __r4_pairs_and_lists_6_3) obj))
	    (js-function-arity 1 0)
	    (js-function-info :name "cdr" :len 1)
	    :size 1))
	 
      (js-bind! %this exports (& "cdr")
	 :value cdr
	 :writable #f
	 :enumerable #t)

      ;; setCar
      (define setCar
	 (js-make-function %this
	    (lambda (this obj val)
	       (set-car! obj val))
	    (js-function-arity 2 0)
	    (js-function-info :name "setCar" :len 2)
	    :size 2))
	 
      (js-bind! %this exports (& "setCar")
	 :value setCar
	 :writable #f
	 :enumerable #t)
      
      ;; setCdr
      (define setCdr
	 (js-make-function %this
	    (lambda (this obj val)
	       (set-cdr! obj val))
	    (js-function-arity 2 0)
	    (js-function-info :name "setCdr" :len 2)
	    :size 2))
	 
      (js-bind! %this exports (& "setCdr")
	 :value setCdr
	 :writable #f
	 :enumerable #t)
      
      ;; lastPair
      (define lastPair
	 (js-make-function %this
	    (lambda (this obj)
	       (last-pair obj))
	    (js-function-arity 1 0)
	    (js-function-info :name "lastPair" :len 1)
	    :size 1))

      (js-bind! %this exports (& "lastPair")
	 :value lastPair
	 :writable #f
	 :enumerable #t)

      ;; map
      (define map
	 (js-make-function %this
	    (lambda (this proc lst)
	       (if (isa? proc JsProcedure)
		   ((@ map  __r4_control_features_6_9)
		    (lambda (e)
		       (js-call1-jsprocedure %this proc lst e))
		    lst)
		   ((@ map  __r4_control_features_6_9)
		    (lambda (e)
		       (js-call1 %this proc lst e))
		    lst)))
	    (js-function-arity 2 0)
	    (js-function-info :name "map" :len 1)
	    :size 1))

      (js-bind! %this exports (& "map")
	 :value map
	 :writable #f
	 :enumerable #t)
      
      ;; forEach
      (define forEach
	 (js-make-function %this
	    (lambda (this proc lst)
	       (if (isa? proc JsProcedure)
		   ((@ for-each  __r4_control_features_6_9)
		    (lambda (e)
		       (js-call1-jsprocedure %this proc lst e))
		    lst)
		   ((@ for-each  __r4_control_features_6_9)
		    (lambda (e)
		       (js-call1 %this proc lst e))
		    lst)))
	    (js-function-arity 2 0)
	    (js-function-info :name "forEach" :len 1)
	    :size 1))

      (js-bind! %this exports (& "forEach")
	 :value forEach
	 :writable #f
	 :enumerable #t)))

